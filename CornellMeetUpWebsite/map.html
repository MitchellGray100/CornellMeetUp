<!DOCTYPE html>
<html lang="en">

<head>
  <title>Cornell MeetUp</title>

  <meta charset="utf-8" />
  <link rel="icon" type="image/x-icon" href= "images/MeetUp Favicon.svg">

  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta name="description" content="This sample shows how to animate the position of a HTML marker on the map by updating the coordinates." />
  <meta name="keywords" content="Microsoft maps, map, gis, API, SDK, animate, animation, symbol, pushpin, marker, pin" />
  <meta name="author" content="Microsoft Azure Maps" />
  <meta name="screenshot" content="screenshot.gif" />

  <!-- Add references to the Azure Maps Map control JavaScript and CSS files. -->
  <link href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.css" rel="stylesheet" />
  <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.js"></script>

  <script>
    const userMap = new Map();
    var username = "<%= username %>";
    console.log(username);

    var map, marker, radius = 20;
    var boundingBox = [-76.493715, 42.440714, -76.454211, 42.453635];

    function GetMap() {
      //Initialize a map instance.
      map = new atlas.Map('myMap', {
        center: [-76.480132, 42.447763],
        // bounds: [-76.487878,42.451176 ,-76.459641 ,42.442595],
        maxBounds: boundingBox,
        zoom: 15,
        style: "satellite_road_labels",
        renderWorldCopies: false,
        authOptions: {
          authType: 'subscriptionKey',
          subscriptionKey: 'EagCYfI95TLS8s0QVYUUaGhC-yI3TdnJA-K1KagP3AI'
        }
      });


      //Wait until the map resources are ready.
      map.events.add('ready', function() {
        datasource = new atlas.source.DataSource();
        map.sources.add(datasource);

        datasource.add(atlas.math.boundingBoxToPolygon(boundingBox));

        //Create a layer to render the outline of the polygon data.
        map.layers.add(new atlas.layer.LineLayer(datasource, null, {
          strokeColor: 'red'
        }));

        apiUrl = "https://cornellmeetup.azurewebsites.net/api/groupinfo?type=getmembers&groupname=1";
        fetch(apiUrl, {
          method: 'GET'
        }).then(response => {
          return response.json();
        }).then(data => {
          // Work with JSON data here
          // console.log(data);
          for (var i = 0; i < data.members.length; i++) {
            if(data.members[i] != username)
            {
              var newMarker = new atlas.HtmlMarker();
              console.log(data.members[i]);
              userMap.set(data.members[i], newMarker);
              map.markers.add(newMarker);
            }
          }
        }).catch(err => {
          // Do something for an error here
        });

        // //Create a HTML marker and add it to the map.
        marker = new atlas.HtmlMarker({
          // htmlContent: '<img class="pulseIcon circleImage" alt="Html Marker" src=""/>',
          position: [0,0]
        });
        // marker2 = new atlas.HtmlMarker({
        //   htmlContent: '<img class="pulseIcon circleImage" alt="Html Marker" src=""/>',
        //   position: [-76.480032, 42.447763]
        // });
        map.markers.add(marker);
        // map.markers.add(marker2);
        //
        // //Start the animation.
        console.log("start animations");
        animateMarker(0);
        // animateMarker(marker2, 0);
        console.log("passed animations");
      });
    }

    function positionOnMap(timer) {
      let output;
      const successCallback = (position) => {
        if (Math.floor(timer) % 5 == 0) {
          output = [position.coords.longitude, position.coords.latitude];
          // console.log("output is" + output);
          const data = {
            longitude: output[0],
            latitude: output[1]
          };
          marker.setOptions({
            position: output
          });
          var apiUrl = 'https://cornellmeetup.azurewebsites.net/api/locationinfo?type=update&username='+username;
          fetch(apiUrl, {
            method: 'POST',
            body: JSON.stringify(data)
          }).then(response => {
            return response.json();
          }).then(data => {
            // Work with JSON data here
            const obj = JSON.parse(data);
            // console.log(obj);
          }).catch(err => {
            // Do something for an error here
          });

          userMap.forEach((value, key) => {
            var apiUrl = 'https://cornellmeetup.azurewebsites.net/api/locationinfo?type=get&username='+key;
            fetch(apiUrl, {
              method: 'GET'
            }).then(response => {
              return response.json();
            }).then(data => {
              userMap.get(key).setOptions({
                position: [data.longitude,data.latitude],
                htmlContent: '<img class="pulseIcon circleImage" alt="Html Marker" src=""/>',
              });
            }).catch(err => {
              console.log(err);
              // Do something for an error here
            });
          });
        }
      };

      const errorCallback = (error) => {
        console.log(error);
      };

      if (Math.floor(timer) % 5 == 0) {
        navigator.geolocation.getCurrentPosition(successCallback, errorCallback);
        apiUrl = 'https://cornellmeetup.azurewebsites.net/api/userinfo?type=get&username='+username;
        outputter = fetch(apiUrl, {
          method: 'GET'
        }).then(response => {
          return response.json();
        }).then(jsonData => {
          marker.setOptions({
              htmlContent: '<img class="pulseIcon circleImage" alt="Html Marker" src="'+jsonData.info.profile_picture_id+'"/>'
          });

        }).catch(err => {
          console.log(err);
        });
      }


      // return output;
      // console.log(position.coords.longitude, position.coords.latitude);
      // console.log(output);
      // console.log(position.coords.latitude);
    }

    function animateMarker(timer) {
      //Update the position of the marker for the animation frame.
      positionOnMap(timer / 1000)

      //Request the next frame of the animation.
      requestAnimationFrame(animateMarker);
    }
  </script>
  <style type="text/css">
    .pulseIcon {
      display: block;
      background: orange;
      border: 2px solid white;
      cursor: pointer;
      box-shadow: 0 0 0 rgba(0, 204, 255, 0.4);
      animation: pulse 3s infinite;
    }

    .pulseIcon:hover {
      animation: none;
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(0, 204, 255, 0.4);
      }

      70% {
        box-shadow: 0 0 0 50px rgba(0, 204, 255, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(0, 204, 255, 0);
      }
    }

    .circleImage {
      width: 40px;
      border: 5px double lime;
      border-radius: 100%;
    }
  </style>
</head>

<body onload='GetMap()'>
  <!-- <div id="myMap" style="margin-left: 25%; margin-right: 25%; text-align: center; display:inline-block; text-align: center; position:relative;width:50%;min-width:290px;height:800px;"></div> -->
  <div id="myMap" style="text-align: center; display:inline-block; text-align: center; position:relative;width:100%;min-width:290px;height:900px;"></div>

</body>

</html>
