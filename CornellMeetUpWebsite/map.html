<!DOCTYPE html>
<html lang="en">

<head>
  <title>Cornell MeetUp</title>

  <meta charset="utf-8" />
  <link rel="icon" type="image/x-icon" href="images/MeetUp Favicon.svg">

  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta name="description" content="This sample shows how to animate the position of a HTML marker on the map by updating the coordinates." />
  <meta name="keywords" content="Microsoft maps, map, gis, API, SDK, animate, animation, symbol, pushpin, marker, pin" />
  <meta name="author" content="Microsoft Azure Maps" />
  <meta name="screenshot" content="screenshot.gif" />

  <!-- Add references to the Azure Maps Map control JavaScript and CSS files. -->
  <link href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.css" rel="stylesheet" />
  <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.js"></script>

  <script>
    function getRandomInt(max) {
      return Math.floor(Math.random() * max);
    }

    const userMap = new Map();
    const pictureMap = new Map();

    var username = "<%= username %>";
    var groups = [];
    var flag = true;
    var pictureFlag = true;
    var starting = true;
    var ready = true;
    console.log(username);

    var map, marker, radius = 20;
    var boundingBox = [-76.493715, 42.440714, -76.454211, 42.453635];

    function GetMap() {
      map = new atlas.Map('myMap', {
        center: [-76.480132, 42.447763],
        maxBounds: boundingBox,
        zoom: 15,
        style: "satellite_road_labels",
        renderWorldCopies: false,
        authOptions: {
          authType: 'subscriptionKey',
          subscriptionKey: 'EagCYfI95TLS8s0QVYUUaGhC-yI3TdnJA-K1KagP3AI'
        }
      });

      map.events.add('ready', function() {
        datasource = new atlas.source.DataSource();
        map.sources.add(datasource);

        datasource.add(atlas.math.boundingBoxToPolygon(boundingBox));

        map.layers.add(new atlas.layer.LineLayer(datasource, null, {
          strokeColor: 'red'
        }));



        apiUrl = "https://cornellmeetup.azurewebsites.net/api/userinfo?type=get&username=" + username;
        fetch(apiUrl, {
          method: 'GET'
        }).then(response => {
          return response.json();
        }).then(data => {
          for (var i = 0; i < data.groups.length; i++) {
            groups.push(data.groups[i]);
          }

        }).catch(err => {
          console.log(err);
        });






        marker = new atlas.HtmlMarker({
          position: [0, 0]
        });
        map.markers.add(marker);
        animateMarker(0);
      });
    }

    function addUsers() {
      flag = false;

      for (var i = 0; i < groups.length; i++) {
        apiUrl = "https://cornellmeetup.azurewebsites.net/api/groupinfo?type=getmembers&groupname=" + groups[i];
        fetch(apiUrl, {
          method: 'GET'
        }).then(response => {
          return response.json();
        }).then(data => {
          for (var i = 0; i < data.members.length; i++) {
            if (data.members[i] != username) {
              var newMarker = new atlas.HtmlMarker({
                htmlContent: '<img class="pulseIcon circleImage" alt="' + data.members[i] + '" src="' + '"/>'
              });
              userMap.set(data.members[i], newMarker);
              map.markers.add(newMarker);
            }
          }
        }).catch(err => {
          console.log(err);
        });
      }
    }

    function changePhotos() {

      userMap.forEach((value, key) => {
        var apiUrl = 'https://cornellmeetup.azurewebsites.net/api/userinfo?type=get&username=' + key;
        fetch(apiUrl, {
          method: 'GET'
        }).then(response => {
          return response.json();
        }).then(data => {
          userMap.get(key).setOptions({
            htmlContent: '<img style="border-color:' + "lime" + ';" class="pulseIcon circleImage" alt="' + key + '" src="' + data.info.profile_picture_id + '"/>'
          });
        }).catch(err => {
          console.log(err);
        });
      });
    }

    function positionOnMap(timer) {
      var doActions = false;
      if (starting) {
        console.log("Starting Application");
        doActions = true;
      }
      if(getRandomInt(60) == 1 && ready == true)
      {
        starting = false;
        ready = false;
        doActions = true;
        console.log("Ready");

      }

      if(getRandomInt(100) == 1)
      {
        starting = false;
        ready = false;
        doActions = true;
        console.log("Updating");

      }

      if (groups.length != 0 && flag == true) {
        addUsers();
      }

      if (doActions) {
        changePhotos();
      }

      let output;
      const successCallback = (position) => {
        if (doActions) {
          output = [position.coords.longitude, position.coords.latitude];
          const data = {
            longitude: output[0],
            latitude: output[1]
          };
          marker.setOptions({
            position: output
          });
          var apiUrl = 'https://cornellmeetup.azurewebsites.net/api/locationinfo?type=update&username=' + username;
          fetch(apiUrl, {
            method: 'POST',
            body: JSON.stringify(data)
          }).then(response => {
            return response;
          }).then(data => {
          }).catch(err => {
            console.log(err);
          });

          userMap.forEach((value, key) => {
            var apiUrl = 'https://cornellmeetup.azurewebsites.net/api/locationinfo?type=get&username=' + key;
            fetch(apiUrl, {
              method: 'GET'
            }).then(response => {
              return response.json();
            }).then(data => {
              userMap.get(key).setOptions({
                position: [data.longitude, data.latitude],
              });
            }).catch(err => {
              console.log(err);
            });
          });
        }
      };

      const errorCallback = (error) => {
        console.log(error);
      };

      if (doActions) {
        navigator.geolocation.getCurrentPosition(successCallback, errorCallback);
        apiUrl = 'https://cornellmeetup.azurewebsites.net/api/userinfo?type=get&username=' + username;
        outputter = fetch(apiUrl, {
          method: 'GET'
        }).then(response => {
          return response.json();
        }).then(jsonData => {
          marker.setOptions({
            htmlContent: '<img class="pulseIcon circleImage" alt="Html Marker" src="' + jsonData.info.profile_picture_id + '"/>'
          });

        }).catch(err => {
          console.log(err);
        });
      }
    }

    function animateMarker(timer) {

      positionOnMap(timer / 1000)
      requestAnimationFrame(animateMarker);
    }
  </script>

  <style type="text/css">
    .pulseIcon {
      display: block;
      background: orange;
      border: 2px solid white;
      cursor: pointer;
      box-shadow: 0 0 0 rgba(0, 204, 255, 0.4);
      animation: pulse 3s infinite;
    }

    .pulseIcon:hover {
      animation: none;
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(0, 204, 255, 0.4);
      }

      70% {
        box-shadow: 0 0 0 50px rgba(0, 204, 255, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(0, 204, 255, 0);
      }
    }

    .circleImage {
      width: 40px;
      height: 40px;
      border: 5px double;
      border-radius: 100%;
    }
  </style>
</head>

<body onload='GetMap()'>
  <!-- <div id="myMap" style="margin-left: 25%; margin-right: 25%; text-align: center; display:inline-block; text-align: center; position:relative;width:50%;min-width:290px;height:800px;"></div> -->
  <div id="myMap" style="text-align: center; display:inline-block; text-align: center; position:relative;width:100%;min-width:290px;height:900px;"></div>

</body>

</html>
